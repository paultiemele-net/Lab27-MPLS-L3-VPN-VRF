! =========================================================
! MPLS L3VPN with VRF, OSPF and MP-BGP LAB
! Goal:
! - R1 communicates with R7
! - R2 communicates with R8
! - R3 communicates with R9
! Using a shared MPLS backbone
! =========================================================


! =======================
! ROUTER 1 (CE)
! =======================

! LAN interface
interface f0/0
 ip address 10.10.10.1 255.255.255.0
 no shutdown
 exit

! Loopback (Customer identifier)
interface loopback0
 ip address 1.1.1.1 255.255.255.255
 no shutdown
 exit

! Default route toward PE (R4)
ip route 0.0.0.0 0.0.0.0 10.10.10.2



! =======================
! ROUTER 2 (CE)
! =======================

interface f0/0
 ip address 20.20.20.1 255.255.255.0
 no shutdown
 exit

interface loopback0
 ip address 2.2.2.2 255.255.255.255
 no shutdown
 exit

ip route 0.0.0.0 0.0.0.0 20.20.20.2



! =======================
! ROUTER 3 (CE)
! =======================

interface f0/0
 ip address 30.30.30.1 255.255.255.0
 no shutdown
 exit

interface loopback0
 ip address 3.3.3.3 255.255.255.255
 no shutdown
 exit

ip route 0.0.0.0 0.0.0.0 30.30.30.2



! =======================
! ROUTER 4 (PE)
! =======================

! Core-facing interfaces
interface f0/0
 ip address 10.10.10.2 255.255.255.0
 mpls ip
 no shutdown
 exit

interface f0/1
 ip address 20.20.20.2 255.255.255.0
 mpls ip
 no shutdown
 exit

interface f2/0
 ip address 30.30.30.2 255.255.255.0
 mpls ip
 no shutdown
 exit

interface f2/1
 ip address 40.40.40.1 255.255.255.0
 mpls ip
 no shutdown
 exit

interface loopback0
 ip address 4.4.4.4 255.255.255.255
 exit


! OSPF inside MPLS core
router ospf 1
 router-id 4.4.4.4
 network 10.10.10.0 0.0.0.255 area 0
 network 20.20.20.0 0.0.0.255 area 0
 network 30.30.30.0 0.0.0.255 area 0
 network 40.40.40.0 0.0.0.255 area 0
 network 4.4.4.4 0.0.0.0 area 0
 exit


! -------- VRF CONFIGURATION --------

! VRF for R1 <-> R7
ip vrf R1-R7
 rd 100:1
 route-target import 100:1
 route-target export 100:1
 route-target import 100:2
 route-target import 100:3

! VRF for R2 <-> R8
ip vrf R2-R8
 rd 100:2
 route-target import 100:2
 route-target export 100:2

! VRF for R3 <-> R9
ip vrf R3-R9
 rd 100:3
 route-target import 100:3
 route-target export 100:3


! Assign VRFs to interfaces
interface f0/0
 ip vrf forwarding R1-R7
 ip address 10.10.10.2 255.255.255.0
 exit

interface f0/1
 ip vrf forwarding R2-R8
 ip address 20.20.20.2 255.255.255.0
 exit

interface f2/0
 ip vrf forwarding R3-R9
 ip address 30.30.30.2 255.255.255.0
 exit


! Static routes per VRF
ip route vrf R1-R7 1.1.1.1 255.255.255.255 10.10.10.1
ip route vrf R2-R8 2.2.2.2 255.255.255.255 20.20.20.1
ip route vrf R3-R9 3.3.3.3 255.255.255.255 30.30.30.1


! -------- MP-BGP CONFIGURATION --------
router bgp 100
 neighbor 6.6.6.6 remote-as 100
 neighbor 6.6.6.6 update-source loopback0
 neighbor 6.6.6.6 next-hop-self

 address-family vpnv4
  neighbor 6.6.6.6 activate
  neighbor 6.6.6.6 send-community both
 exit-address-family

 address-family ipv4 vrf R1-R7
  redistribute connected
  redistribute static
 exit-address-family

 address-family ipv4 vrf R2-R8
  redistribute connected
  redistribute static
 exit-address-family

 address-family ipv4 vrf R3-R9
  redistribute connected
  redistribute static
 exit-address-family

exit



! =======================
! ROUTER 5 (P)
! =======================

interface f0/0
 ip address 40.40.40.2 255.255.255.0
 mpls ip
 no shutdown
 exit

interface f0/1
 ip address 50.50.50.2 255.255.255.0
 mpls ip
 no shutdown
 exit

interface loopback0
 ip address 5.5.5.5 255.255.255.255
 exit

router ospf 1
 router-id 5.5.5.5
 network 40.40.40.0 0.0.0.255 area 0
 network 50.50.50.0 0.0.0.255 area 0
 network 5.5.5.5 0.0.0.0 area 0
 exit



! =======================
! ROUTER 6 (PE)
! =======================

interface f0/0
 ip address 60.60.60.2 255.255.255.0
 mpls ip
 no shutdown
 exit

interface f0/1
 ip address 50.50.50.1 255.255.255.0
 mpls ip
 no shutdown
 exit

interface f2/0
 ip address 70.70.70.2 255.255.255.0
 mpls ip
 no shutdown
 exit

interface f2/1
 ip address 80.80.80.2 255.255.255.0
 mpls ip
 no shutdown
 exit

interface loopback0
 ip address 6.6.6.6 255.255.255.255
 exit


router ospf 1
 router-id 6.6.6.6
 network 50.50.50.0 0.0.0.255 area 0
 network 60.60.60.0 0.0.0.255 area 0
 network 70.70.70.0 0.0.0.255 area 0
 network 80.80.80.0 0.0.0.255 area 0
 network 6.6.6.6 0.0.0.0 area 0
 exit


! MP-BGP PE to PE
router bgp 100
 neighbor 4.4.4.4 remote-as 100
 neighbor 4.4.4.4 update-source loopback0
 neighbor 4.4.4.4 next-hop-self

 address-family vpnv4
  neighbor 4.4.4.4 activate
  neighbor 4.4.4.4 send-community both
 exit-address-family
exit
